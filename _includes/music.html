<!-- APlayer -->
<link rel="stylesheet" href="https://unpkg.com/aplayer/dist/APlayer.min.css">
<script src="https://unpkg.com/aplayer/dist/APlayer.min.js"></script>

<style>
  /* æ‚¬æµ®æŒ‰é’® */
  #music-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    width: 42px;
    height: 42px;
    background: rgba(255,255,255,0.8);
    border-radius: 50%;
    backdrop-filter: blur(5px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    z-index: 99999;
    font-size: 20px;
  }
  #music-btn:hover {
    background: rgba(255,255,255,1);
  }

  /* æ’­æ”¾å™¨å®¹å™¨ */
  #player-bar {
    position: fixed;       /* å›ºå®šåœ¨å±å¹•è§’è½ */
    bottom: 20px;
    right: 20px;           /* é»˜è®¤å³ä¸‹è§’ï¼Œå¯æ‹–æ‹½ç§»åŠ¨ */
    width: 320px;           /* åˆå§‹å®½åº¦ï¼Œå¯è‡ªé€‚åº” */
    max-width: 90%;         /* å±å¹•å®½åº¦å°äºåˆå§‹å®½åº¦æ—¶è‡ªé€‚åº” */
    z-index: 99998;
    cursor: move;
    transition: width 0.2s, height 0.2s;
  }
</style>

<div id="music-btn">ğŸµ</div>
<div id="player-bar"></div>

<script>
const btn = document.getElementById('music-btn');
const bar = document.getElementById('player-bar');

// ç‚¹å‡»æŒ‰é’®æ˜¾ç¤º/éšè—æ’­æ”¾å™¨
btn.onclick = function() {
  if(bar.style.display === "none" || !bar.style.display){
    bar.style.display = "block";
  } else {
    bar.style.display = "none";
  }
};

// æ‹–æ‹½åŠŸèƒ½
let isDragging = false, offsetX = 0, offsetY = 0;
bar.addEventListener('mousedown', e => {
  isDragging = true;
  offsetX = e.clientX - bar.offsetLeft;
  offsetY = e.clientY - bar.offsetTop;
  bar.style.transition = 'none';
});
document.addEventListener('mousemove', e => {
  if(isDragging){
    let left = e.clientX - offsetX;
    let top = e.clientY - offsetY;
    // é™åˆ¶åœ¨å±å¹•èŒƒå›´å†…
    left = Math.max(0, Math.min(window.innerWidth - bar.offsetWidth, left));
    top = Math.max(0, Math.min(window.innerHeight - bar.offsetHeight, top));
    bar.style.left = left + 'px';
    bar.style.top = top + 'px';
    bar.style.right = 'auto';
    bar.style.bottom = 'auto';
  }
});
document.addEventListener('mouseup', () => {
  if(isDragging){
    isDragging = false;
    bar.style.transition = '';
    savePosition();
  }
});

// ä¿å­˜ä½ç½®
function savePosition(){
  localStorage.setItem('aplayerPos', JSON.stringify({left: bar.style.left, top: bar.style.top}));
}

// æ¢å¤ä½ç½®
const savedPos = localStorage.getItem('aplayerPos');
if(savedPos){
  const pos = JSON.parse(savedPos);
  bar.style.left = pos.left;
  bar.style.top = pos.top;
  bar.style.right = 'auto';
  bar.style.bottom = 'auto';
}

// è¯»å– music.json å¹¶åˆå§‹åŒ–æ’­æ”¾å™¨
fetch("{{ '/assets/music/music.json' | relative_url }}")
.then(res => res.json())
.then(data => {
  const musicList = data.map(item => ({
    name: item.name && item.name.trim() ? item.name : "æœªçŸ¥",
    artist: item.artist && item.artist.trim() ? item.artist : "æœªçŸ¥",
    url: "{{ '/assets/music/' | relative_url }}" + item.file,
    cover: "{{ '/assets/music/cover/' | relative_url }}" + (item.cover && item.cover.trim() ? item.cover : "cover.jpg")
  }));

  const ap = new APlayer({
    container: bar,
    fixed: false,
    audio: musicList,
    listFolded: false,
    order: 'list',
    autoplay: false,
    preload: 'auto'
  });

  // æ¢å¤æ’­æ”¾çŠ¶æ€
  const savedState = localStorage.getItem('aplayerState');
  if(savedState){
    const state = JSON.parse(savedState);
    if(state.index !== undefined) ap.list.switch(state.index);
    if(state.time !== undefined) ap.seek(state.time);
    if(state.playing) ap.play();
  }

  // ä¿å­˜æ’­æ”¾çŠ¶æ€
  function saveState(){
    const state = {
      index: ap.list.index,
      time: ap.audio.currentTime,
      playing: !ap.audio.paused
    };
    localStorage.setItem('aplayerState', JSON.stringify(state));
  }
  ap.on('play', saveState);
  ap.on('pause', saveState);
  ap.on('ended', saveState);
  ap.on('switch', saveState);
  ap.on('timeupdate', saveState);
});

// åˆå§‹éšè—æ’­æ”¾å™¨
bar.style.display = "none";
</script>
